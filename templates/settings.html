{% extends "base.html" %}

{% block title %}User Settings{% endblock %}

{% block content %}
<div class="container">
    <h2>User Settings</h2>

    {# Display Flashed Messages #}
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="flash flash-{{ category }}">{{ message }}</div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    {# Account Information Section #}
    <div class="settings-section">
        <h3>Account Information</h3>
        <p><strong>Username:</strong> {{ user.username }}</p>
        <p>
            <strong>Subscription Status:</strong> 
            {% if user_details.is_subscribed %}
                <span class="status-subscribed">Active</span>
            {% else %}
                <span class="status-free">Free Tier</span>
            {% endif %}
        </p>
        {% if not user_details.is_subscribed %}
        <p>
            <strong>Token Usage:</strong> 
            {{ user_details.tokens_used if user_details.tokens_used != 'N/A' else '0' }} / {{ token_limit }}
            {# Optional: Add a progress bar #}
             <progress value="{{ user_details.tokens_used if user_details.tokens_used != 'N/A' else '0' }}" max="{{ token_limit }}" style="width: 100%;"></progress>
        </p>
        <a href="{{ url_for('settings.subscribe_page') }}" class="button button-primary">Subscribe Now</a>
        {% else %}
         <p>Thank you for subscribing!</p>
         {# Add link to manage subscription if needed #}
        {% endif %}
    </div>

    {# Chat History Section #}
    <div class="settings-section">
        <h3>Chat History (Last {{ history|length }} messages)</h3>
        <div class="chat-history-box">
            {% if history %}
                {% for message in history %}
                    <div class="history-message history-{{ message.role }}">
                        <span class="history-role">{{ message.role.capitalize() }}:</span>
                        {# Use pre for whitespace preservation, escape content #}
                        <pre class="history-content">{{ message.content|escape }}</pre> 
                        <span class="history-timestamp">{{ message.timestamp.strftime('%Y-%m-%d %H:%M:%S') if message.timestamp else '' }} UTC</span>
                    </div>
                {% endfor %}
            {% else %}
                <p>No chat history found.</p>
            {% endif %}
        </div>
    </div>

    <a href="{{ url_for('index') }}" class="button button-secondary">Back to Chat</a>

</div>

{# Add some specific styles for this page #}
<style>
  .container { max-width: 800px; margin: 20px auto; padding: 20px; background-color: #fff; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
  .settings-section { margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid #eee; }
  .settings-section h3 { margin-top: 0; color: #333; }
  .status-subscribed { color: green; font-weight: bold; }
  .status-free { color: orange; font-weight: bold; }
  .chat-history-box { max-height: 400px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; background-color: #f9f9f9; border-radius: 4px; }
  .history-message { margin-bottom: 10px; padding: 8px; border-radius: 4px; }
  .history-user { background-color: #e1f5fe; }
  .history-assistant { background-color: #f1f1f1; }
  .history-system { background-color: #fffacd; font-style: italic; font-size: 0.9em; }
  .history-error { background-color: #fdecea; color: #a94442; }
  .history-role { font-weight: bold; margin-right: 5px; display: block; color: #555; }
  .history-content { white-space: pre-wrap; word-wrap: break-word; margin: 5px 0; font-family: monospace; }
  .history-timestamp { font-size: 0.8em; color: #888; display: block; text-align: right; margin-top: 3px; }
  .button { display: inline-block; padding: 10px 15px; background-color: #007bff; color: white; text-decoration: none; border-radius: 4px; text-align: center; margin-top: 10px; border: none; cursor: pointer; }
  .button-primary { background-color: #007bff; }
  .button-secondary { background-color: #6c757d; }
  .button:hover { opacity: 0.9; }
  pre { margin: 0; }
</style>
{% endblock %} 