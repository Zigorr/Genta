<!doctype html>
<html>
<head>
    <title>Website Monitor Agency</title>
    <style>
        body { font-family: sans-serif; margin: 20px; background-color: #f0f2f5; }
        #chat-container { max-width: 800px; margin: auto; background-color: #fff; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: flex; flex-direction: column; height: 90vh; }
        #chatbox { flex-grow: 1; overflow-y: scroll; border: 1px solid #ccc; padding: 15px; margin-bottom: 10px; background-color: #ffffff; }
        .message { margin-bottom: 12px; padding: 8px 12px; border-radius: 18px; max-width: 75%; word-wrap: break-word; line-height: 1.4; }
        .user { background-color: #0084ff; color: white; text-align: left; margin-left: auto; border-bottom-right-radius: 4px; }
        .assistant { background-color: #e4e6eb; color: #050505; text-align: left; margin-right: auto; border-bottom-left-radius: 4px; }
        .system-message { font-style: italic; color: #65676b; text-align: center; margin: 10px 0; font-size: 0.9em; }
        .error { color: #fa3e3e; font-weight: bold; }
        /* Corrected class name */
        .assistant-error { background-color: #fdecea; color: #a94442; margin-right: auto; border-bottom-left-radius: 4px; }
        #input-area { display: flex; padding: 10px; border-top: 1px solid #ccc; background-color: #f0f2f5; }
        #input-area input { flex-grow: 1; padding: 10px; margin-right: 10px; border-radius: 18px; border: 1px solid #ccc; }
        #input-area input:focus { outline: none; border-color: #0084ff; }
        #input-area button { padding: 10px 15px; border-radius: 18px; border: none; background-color: #0084ff; color: white; cursor: pointer; }
        #input-area button:disabled { background-color: #a0c3ff; cursor: not-allowed; }
        #logout { position: absolute; top: 10px; right: 10px; }
        #subscribe-section { margin-top: 15px; padding: 10px; border: 1px solid #ffecb3; background-color: #fff9c4; text-align: center; border-radius: 4px; }
        #header { display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; border-bottom: 1px solid #ccc; background-color: #f8f9fa; }
        #header h1 { margin: 0; text-align: left; font-size: 1.5em; }
        #user-nav { display: flex; align-items: center; }
        #user-nav a { text-decoration: none; color: #007bff; margin-left: 15px; }
        #user-nav a:hover { text-decoration: underline; }
        .button-subscribe { background-color: #17a2b8; } /* Teal color for subscribe */
        .button-subscribe:hover { background-color: #138496; }
    </style>
</head>
<body>
    <div id="chat-container">
        <div id="header">
             <h1>Website Monitor Agency</h1>
             <div id="user-nav">
                 {# Check if current_user is loaded and authenticated #}
                 {% if current_user and current_user.is_authenticated %}
                     {# Link to User Settings page using username #}
                     <a href="{{ url_for('settings.view_settings') }}" title="Settings">{{ current_user.username }}</a> 
                 {% endif %}
                 <a href="{{ url_for('auth.logout') }}">Logout</a>
            </div>
        </div>

        <div id="chatbox">
            <!-- Chat messages will appear here -->
            <!-- Load initial chat history -->
            {% if history %}
                {% for message in history %}
                    {# Only display user and assistant messages #}
                    {% if message[3] == 'user' or message[3] == 'assistant' %}
                        {# Determine CSS class based on role #}
                        {% set role_class = message[3] %} {# Use role directly #}
                        <div class="message {{ role_class }}">
                            {{ message[4] }} {# Display the content #}
                        </div>
                    {% endif %}
                {% endfor %}
            {% endif %}
            <!-- New messages will be added by JavaScript below this -->
        </div>

        <!-- Subscription message area -->
        <div id="subscribe-section" style="display: none; padding: 10px;">
            <!-- Content will be added by JavaScript -->
        </div>

        <form id="input-area">
            <input type="text" id="message-input" placeholder="Enter task (e.g., monitor URL X with selector Y)" autocomplete="off">
            <button type="submit" id="send-button">Send</button>
        </form>
    </div>

    <script>
        const chatbox = document.getElementById('chatbox');
        const messageInput = document.getElementById('message-input');
        const inputForm = document.getElementById('input-area');
        const sendButton = document.getElementById('send-button');
        const subscribeSection = document.getElementById('subscribe-section');
        let currentConversationId = null; // Add state for current conversation

        function addMessage(role, text) {
            // Only add user or assistant messages to the display
            if (role === 'user' || role === 'assistant') {
                const messageDiv = document.createElement('div');
                // Original logic for setting class:
                // const messageRoleClass = role.includes('error') ? 'assistant-error' : role;
                // Simplified class setting since we only have user/assistant now:
                 const messageRoleClass = role;
                messageDiv.classList.add('message', messageRoleClass);

                const textNode = document.createTextNode(text);
                messageDiv.appendChild(textNode);
                chatbox.appendChild(messageDiv);
                chatbox.scrollTop = chatbox.scrollHeight;
            }
        }

        function handleSubscribeClick() {
            // Placeholder for your subscription logic
            alert("Subscription feature coming soon!");
            // Or redirect: window.location.href = '/subscribe-page';
        }

        inputForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const message = messageInput.value.trim();
            if (!message) return;

            addMessage('user', message); // Add user message to UI
            messageInput.value = '';
            messageInput.disabled = true;
            sendButton.disabled = true;
            subscribeSection.style.display = 'none';

            try {
                // Send currentConversationId to the backend
                const payload = { message: message };
                if (currentConversationId) {
                    payload.conversation_id = currentConversationId;
                }

                const response = await fetch("{{ url_for('agency_api.agency_chat') }}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload) // Send payload with convo ID
                });

                let data = {};
                try { data = await response.json(); } catch (jsonError) { /* ... */ throw new Error(`HTTP error! ...`); }

                // Update currentConversationId if it was a new conversation
                if (data.conversation_id && data.is_new_conversation) {
                    currentConversationId = data.conversation_id;
                    // TODO: Add the new conversation to the sidebar list dynamically
                    console.log("New conversation created with ID:", currentConversationId);
                    // Optionally update URL: history.pushState({}, '', '/chat/' + currentConversationId);
                } else if (data.conversation_id) {
                     currentConversationId = data.conversation_id; // Ensure it's set even for existing convos
                }

                if (response.status === 403 && data.limit_reached === true) {
                    // Add message (won't display if addMessage is filtered, use console or dedicated element)
                     console.warn("Token Limit Message:", data.message);
                    // subscribeSection handling...
                    const subscribeUrl = '/settings/subscribe';
                    subscribeSection.innerHTML = `<p>${data.message}</p><p>You can subscribe to our service</p><a href="${subscribeUrl}" class="button button-subscribe">Subscribe</a>`;
                    subscribeSection.style.display = 'block';
                } else if (!response.ok) {
                    const errorText = data.error || `API Error: ${response.status} ${response.statusText}`;
                    // Log error, maybe show a generic message via a different mechanism
                    console.error("API Error:", errorText);
                    // addMessage('error', `Sorry, an error occurred: ${errorText}`); // This won't display
                    alert(`Sorry, an error occurred: ${errorText}`); // Simple alert for now
                    throw new Error(errorText); // Re-throw to be caught by outer catch
                } else {
                    // Display assistant response (addMessage will filter roles)
                    // Steps are no longer sent/logged, so no need to display them
                    // if (data.steps && data.steps.trim() !== '') {
                    //    addMessage('system-message', `--- Agent Steps ---\n${data.steps}`);
                    // }
                    addMessage('assistant', data.response);
                }
            } catch (error) {
                // Log error and potentially show user
                console.error('Error fetching/processing chat response:', error);
                // addMessage('assistant-error', `Sorry, an error occurred: ${error.message}.`); // This won't display
                // Use alert or a dedicated error display area
                alert(`An error occurred while sending your message.`);
            } finally {
                messageInput.disabled = false;
                sendButton.disabled = false;
                messageInput.focus();
            }
        });

        // --- TODO: Add JS for Sidebar, New Chat Button, Loading Messages --- 
        // Example placeholder for loading messages when a conversation is clicked
        async function loadConversation(conversationId) {
             if (!conversationId) return;
             console.log("Loading conversation:", conversationId);
             chatbox.innerHTML = ''; // Clear existing messages
             currentConversationId = conversationId;
             messageInput.disabled = true;
             sendButton.disabled = true;

             // TODO: Add visual selection indication to sidebar item

             try {
                const response = await fetch(`/api/conversations/${conversationId}/messages`);
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `Failed to load messages: ${response.status}`);
                }
                const messages = await response.json();
                messages.forEach(msg => addMessage(msg.role, msg.content));
             } catch (error) {
                 console.error("Error loading conversation history:", error);
                 addMessage('error', `Failed to load chat history: ${error.message}`); // This won't display
                 alert(`Failed to load chat history: ${error.message}`);
             } finally {
                  messageInput.disabled = false;
                  sendButton.disabled = false;
                  messageInput.focus();
                  chatbox.scrollTop = chatbox.scrollHeight; // Scroll to bottom after loading
             }
        }

        messageInput.focus();
    </script>
</body>
</html> 